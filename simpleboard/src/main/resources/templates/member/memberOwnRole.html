<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleag.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout_board_list.html}"
>
<body>
<section layout:fragment="content" class="py-5">
    <div class="container h-100">
        <div class="container row">
            <divc class="col input-group-prepend">
                <select class="form-select" name="type">
                    <option value="" selcted>----------</option>
                    <option value="i">id</option>
                    <option value="n">nickname</option>
                    <option value="in">id+nickname</option>
                </select>
            </divc>
            <input type="text" class="col form-control" name="keyword">
            <divc class="col input-group-append">
                <button type="button" class="btn btn-primary" onclick="searchBtnClicked()">Search</button>
            </divc>
        </div>
        <div class="container row">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>nickname</th>
                        <th>select</th>
                    </tr>
                </thead>
                <tbody class="tableBody">
                </tbody>
            </table>
        </div>
        <div class="container row ">
            <div class="searchPager col">
            </div>
        </div>

        <div class="container row align-items-start align-items-center ownRoleDiv">
            <div class="col-5">
                <label> cur member none own role list</label>
                <select class="form-select noneOwnRoleSelector" size="10" aria-label="size 3 select example">
                </select>
            </div>
            <div class="container col-2 h-100 d-inline-block">
                <div class="container row flex-col justify-content-center">
                    <div class="d-flex row">
                        <button type="button" class="btn btn-primary align-top insertBtn">
                            >
                        </button>
                    </div>
                    <div class="d-flex row">
                        <button type="button" class="btn btn-out-line-dark align-bottom deleteBtn">
                            <
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-5">
                <label> cur member own role list</label>
                <select class="form-select ownRoleSelector" size="10" aria-label="size 3 select example">
                </select>
            </div>
        </div>
    </div>
</section>

<script layout:fragment="script" th:inline="javascript">

    const searchType = document.querySelector("select[name='type']");
    const searchText = document.querySelector("input[name='keyword']");
    let curPage = 1;
    let curSearchType = '';
    let curKeyword = '';

    const tableBody = document.querySelector(".tableBody");
    const searchPager = document.querySelector(".searchPager");



    function searchBtnClicked() {
        console.log("searchBtnClicked");
        const curSearchOption = searchType[searchType.selectedIndex];
        curSearchType = curSearchOption.value;

        clearRoleSelector();

        curKeyword = searchText.value;
        if(curKeyword === null){
            curKeyword = '';
        }
        console.log(`cur input : [${curSearchType}][${curKeyword}]`);

        var pageRequestDTO = {
            pageSize : 10
            , page : curPage
            , type : curSearchType
            , keyword : curKeyword
        };

        searchMember(pageRequestDTO);

        return ;
    }

    function searchMember(pageRequestDTO) {

        let page = pageRequestDTO.page;
        let type = ""+pageRequestDTO.type;
        let keyword = ""+pageRequestDTO.keyword;

        axios.get(`/members/profiles`, {
            params : {
                page:page
                , pageSize : 10
                , type : `${type}`
                , keyword : `${keyword}`
            }
        })
        .then(res=>{
            setTableBodyData(res.data.dtoList);
            setSearchPager(res.data);

            return ;
        })
        .catch(e=>{
            console.error(e);
        });
    }

    function setTableBodyData(dtoList) {

        let str = '';
        for(let dto of dtoList) {
            str += `
                <tr>
                    <td>${dto.id}</td>
                    <td>${dto.nickname}</td>
                    <td>
                        <button type="button" class=" btn btn-secondary" onclick="selectBtnClicked(${dto.id})">Select</button>
                    </td>
                </tr>
            `;
        }
        tableBody.innerHTML = str;
        return ;
    }

    function setSearchPager(pageResponseDTO) {
        let str = '';
        let start = pageResponseDTO.start;
        let end = pageResponseDTO.end;
        let prev = pageResponseDTO.prev;
        let next = pageResponseDTO.next;
        let page = pageResponseDTO.page;

        if(prev) {
            str += `
                <button class='btn btn-primary'><</button>
            `;
        } else {
            str += `
                <button class='btn btn-secondary' disable><</button>
            `;
        }

        for(let curPage = start; curPage <= end; curPage++) {
            if(curPage == page) {
                str += `
                    <button type="button" class="btn btn-primary">${curPage}</button>
                `;
            } else {
                str += `
                    <button type="button" class="btn btn-primary">${curPage}</button>
                `;
            }
        }

        if(next) {
            str += `
                <button class='btn btn-primary'>></button>
            `;
        } else {
            str += `
                <button class='btn btn-secondary' disable>></button>
            `;
        }

        searchPager.innerHTML = str;

        return ;
    };




    const ownRoleDiv = document.querySelector(".ownRoleDiv");
    const noneOwnRoleSelector = document.querySelector(".noneOwnRoleSelector");
    const ownRoleSelector = document.querySelector(".ownRoleSelector");
    const insertBtn = document.querySelector(".insertBtn");
    const deleteBtn = document.querySelector(".deleteBtn");
    let curProfileId = 0;

    function selectBtnClicked(profileId) {

        curProfileId = profileId;

        axios.get("/members/own/roles", {
            params:{
                profileId : profileId
            }
        }).then(res=>{
            dto = res.data;
            setNoneOwnRoleSelect(dto.noneRoleDTOList);
            setOwnRoleSelect(dto.roleDTOList);
        }).catch(e=>{
            console.error(e);
        });
    };

    function setOwnRoleSelect(roleList) {
        console.log(`own role list : ${roleList}`);
        ownRoleSelector.innerHTML = '';
        let str = '';
        for(let role of roleList) {
            str += `
                <option value=${role.id}>${role.name}</option>
            `;
        }

        ownRoleSelector.innerHTML = str;

        return ;
    };

    function setNoneOwnRoleSelect(roleList) {
        console.log(`NoneOwnRoleSelect : ${roleList}`);
        noneOwnRoleSelector.innerHTML = '';

        let str = '';

        for(let role of roleList) {
            str += `
                <option value=${role.id}>${role.name}</option>
            `;
        }

        noneOwnRoleSelector.innerHTML = str;

        return ;
    };

    insertBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();

        let curIdx = noneOwnRoleSelector.selectedIndex;
        let value = noneOwnRoleSelector[curIdx].value;
        let name = noneOwnRoleSelector[curIdx].text;

        axios.post(`/members/own/roles/${curProfileId}`, {
            id : value
            , name : name
        }).then(res=>{
            if(res.data) {
                console.log(`member own role[${name}] create is success`);
                let opt = noneOwnRoleSelector[curIdx];
                noneOwnRoleSelector.remove(curIdx);
                ownRoleSelector.append(opt);
                ownRoleSelector.selected = -1;
                return ;
            } else {
                console.log("member own role create is failed");
                return ;
            }
        }).catch(e=>{
            console.error(e);
        });
    }, false);

    deleteBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();

        let curIdx = ownRoleSelector.selectedIndex;
        let value = ownRoleSelector[curIdx].value;
        let name = ownRoleSelector[curIdx].text;

        axios.delete(`/members/own/roles/${curProfileId}`, {
            data : {
                id : value
                , name : name
            }, headers : {
                'Content-Type' : 'application/json'
            }
        }).then(res=>{
            if(res.data) {
                console.info(`${name} role delete success`);
                let opt = ownRoleSelector[curIdx];
                ownRoleSelector.remove(curIdx);
                noneOwnRoleSelector.append(opt);
                noneOwnRoleSelector.selected = -1;
                return ;
            } else {
                console.error(`${name} role delete failed`);
                return ;
            }
        }).catch(e=>{
            console.error(e);
        })

    }, false);

    function clearRoleSelector() {
        noneOwnRoleSelector.innerHTML = '';
        ownRoleSelector.innerHTML = '';
        curProfileId = 0;
    }

    searchBtnClicked();

</script>

</body>
</html>